<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceFlow | Pro Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --bg: #0b0e14;
            --card: #161b22;
            --accent: #38bdf8;
            --success: #22c55e;
            --danger: #ef4444;
            --border: #30363d;
        }

        body {
            background: var(--bg);
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        .card-custom {
            background: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid var(--border);
            height: 100%;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card-custom:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
        }

        .btn-delete { color: #fb7185; cursor: pointer; font-weight: bold; font-size: 1.2rem; transition: 0.2s; }
        .btn-delete:hover { color: #f43f5e; transform: scale(1.2); }

        .balance-box {
            background: rgba(56, 189, 248, 0.05);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.5s ease;
        }

        .table { color: #cbd5e1; border-color: var(--border); }
        .form-control { background-color: #0b0e14 !important; color: white !important; border-color: var(--border) !important; }

        .btn-primary { background: linear-gradient(135deg, #38bdf8, #0284c7); border: none; }
        .btn-success { background: linear-gradient(135deg, #22c55e, #16a34a); border: none; }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); border: none; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
    </style>
</head>
<body class="container py-5">

<div class="d-flex justify-content-between align-items-center mb-5">
    <div>
        <h1 class="fw-bold m-0">Finance<span style="color:var(--accent)">Flow</span></h1>
        <p class="text-muted">Smart Expense Tracking</p>
    </div>
    <div class="d-flex gap-2">
        <button onclick="generatePDF()" class="btn btn-primary rounded-pill px-4">ðŸ“„ Export PDF</button>
        <button onclick="clearAllData()" class="btn btn-outline-danger rounded-pill px-4">ðŸ—‘ Clear All</button>
    </div>
</div>

<div class="row mb-5 justify-content-center">
    <div class="col-md-4">
        <div id="balanceContainer" class="balance-box">
            <small class="text-uppercase fw-bold text-muted">Net Balance</small>
            <h2 id="netBalance" class="display-6 fw-bold text-info">0</h2>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-6">
        <div class="card-custom">
            <h4 class="text-success mb-4">+ Income</h4>
            <div class="input-group mb-4">
                <input type="text" id="incSource" class="form-control" placeholder="Source">
                <input type="number" id="incAmt" class="form-control" placeholder="Amount">
                <button onclick="addIncome()" class="btn btn-success px-4">Add</button>
            </div>
            <table class="table table-hover"><tbody id="incomeTable"></tbody></table>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card-custom">
            <h4 class="text-danger mb-4">- Expenses</h4>
            <div class="input-group mb-4">
                <input type="text" id="expDesc" class="form-control" placeholder="Description">
                <input type="number" id="expAmt" class="form-control" placeholder="Amount">
                <button onclick="addExpense()" class="btn btn-danger px-4">Add</button>
            </div>
            <table class="table table-hover"><tbody id="expenseTable"></tbody></table>
        </div>
    </div>
</div>

<div class="row mt-5">
    <div class="col-12">
        <div class="card-custom">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="m-0">Visual Analytics</h4>
                <small id="lastUpdated" class="text-muted" style="font-size: 0.75rem;"></small>
            </div>
            <div style="height: 300px;"><canvas id="financeChart"></canvas></div>
        </div>
    </div>
</div>

<script>
    // --- SMART URL LOGIC ---
    // If running on local machine, use localhost:8080. If on web, use Render URL.
    const BASE_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
        ? "http://localhost:8081"
        : "https://financeflow-tracker.onrender.com";

    const API_EXP = `${BASE_URL}/api/expenses`;
    const API_INC = `${BASE_URL}/api/income`;
    // -----------------------

    let myChart;
    const fmt = (num) => new Intl.NumberFormat('en-IN').format(num);

    async function fetchData() {
        try {
            const [resExp, resInc] = await Promise.all([fetch(API_EXP), fetch(API_INC)]);
            const expenses = await resExp.json();
            const incomes = await resInc.json();
            let tIn = 0, tOut = 0;

            const render = (data, elementId, colorClass, prefix, type) => {
                const el = document.getElementById(elementId);
                el.innerHTML = "";
                data.forEach(item => {
                    const amt = parseFloat(item.amount);
                    if(type === 'expense') tOut += amt; else tIn += amt;
                    el.innerHTML += `<tr>
                        <td>${item.source || item.description}</td>
                        <td class="text-end fw-bold ${colorClass}">${prefix}${fmt(amt)}</td>
                        <td class="text-end" style="width: 50px;">
                            <span class="btn-delete" onclick="deleteRecord(${item.id}, '${type}')">âœ•</span>
                        </td>
                    </tr>`;
                });
            };

            render(expenses, "expenseTable", "text-danger", "-", "expense");
            render(incomes, "incomeTable", "text-success", "+", "income");

            const netValue = tIn - tOut;
            const balanceEl = document.getElementById("netBalance");
            const balanceBox = document.getElementById("balanceContainer");
            balanceEl.innerText = fmt(netValue);

            if (netValue > 0) {
                balanceEl.className = "display-6 fw-bold text-success";
                balanceBox.style.borderColor = "var(--success)";
            } else if (netValue < 0) {
                balanceEl.className = "display-6 fw-bold text-danger";
                balanceBox.style.borderColor = "var(--danger)";
            } else {
                balanceEl.className = "display-6 fw-bold text-info";
                balanceBox.style.borderColor = "var(--border)";
            }

            document.getElementById("lastUpdated").innerText = "Last synced: " + new Date().toLocaleTimeString();
            updateChart(tIn, tOut);
        } catch (error) {
            console.error("Error fetching data:", error);
            document.getElementById("lastUpdated").innerText = "Error: Check if backend is running!";
        }
    }

    function updateChart(inc, exp) {
        const ctx = document.getElementById('financeChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Income', 'Expenses'],
                datasets: [{
                    data: [inc, exp],
                    backgroundColor: ['#22c55e', '#ef4444'],
                    hoverOffset: 15,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#cbd5e1', font: { family: 'Inter' } } }
                }
            }
        });
    }

    async function addIncome() {
        const source = document.getElementById("incSource").value;
        const amount = document.getElementById("incAmt").value;
        if(!source || !amount) return;
        await fetch(API_INC, { method: "POST", headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ source, amount, date: new Date().toISOString().split('T')[0] }) });
        document.getElementById("incSource").value = ""; document.getElementById("incAmt").value = "";
        fetchData();
    }

    async function addExpense() {
        const description = document.getElementById("expDesc").value;
        const amount = document.getElementById("expAmt").value;
        if(!description || !amount) return;
        await fetch(API_EXP, { method: "POST", headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ description, amount, date: new Date().toISOString().split('T')[0] }) });
        document.getElementById("expDesc").value = ""; document.getElementById("expAmt").value = "";
        fetchData();
    }

    async function deleteRecord(id, type) {
        const url = type === 'income' ? API_INC : API_EXP;
        if (confirm("Delete entry?")) { await fetch(`${url}/${id}`, { method: "DELETE" }); fetchData(); }
    }

    async function clearAllData() {
        if (confirm("Wipe entire database?")) {
            await Promise.all([fetch(`${API_EXP}/clear`, {method: "DELETE"}), fetch(`${API_INC}/clear`, {method: "DELETE"})]);
            fetchData();
        }
    }

    async function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(20);
        doc.text("FinanceFlow Report", 14, 20);
        doc.setFontSize(10);
        doc.text("Generated on: " + new Date().toLocaleString(), 14, 28);

        const [re, ri] = await Promise.all([fetch(API_EXP), fetch(API_INC)]);
        const ex = await re.json(), in_ = await ri.json(), rows = [];

        in_.forEach(i => rows.push([i.date, i.source, "Income", `+${fmt(i.amount)}`]));
        ex.forEach(e => rows.push([e.date, e.description, "Expense", `-${fmt(e.amount)}`]));

        doc.autoTable({
            startY: 35,
            head: [['Date', 'Description', 'Type', 'Amount']],
            body: rows,
            theme: 'striped',
            headStyles: { fillColor: [56, 189, 248] }
        });
        doc.save("Finance_Report.pdf");
    }

    fetchData();
</script>
</body>
</html>