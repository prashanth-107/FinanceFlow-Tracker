<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceFlow | Pro Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; }
        body { background: var(--bg); color: #f8fafc; font-family: 'Inter', sans-serif; min-height: 100vh; }
        .card-custom { background: var(--card); border-radius: 15px; padding: 25px; border: 1px solid #334155; height: 100%; }
        .btn-delete { color: #fb7185; cursor: pointer; font-weight: bold; font-size: 1.2rem; transition: 0.2s; }
        .btn-delete:hover { color: #f43f5e; transform: scale(1.2); }
        .balance-box { background: rgba(56, 189, 248, 0.1); border: 1px solid var(--accent); border-radius: 15px; padding: 20px; text-align: center; }
        .table { color: #cbd5e1; border-color: #334155; }
        .form-control { background-color: #0f172a !important; color: white !important; border-color: #475569 !important; }
    </style>
</head>
<body class="container py-5">

<div class="d-flex justify-content-between align-items-center mb-5">
    <div>
        <h1 class="fw-bold m-0">Finance<span style="color:var(--accent)">Flow</span></h1>
        <p class="text-muted">Smart Expense Tracking</p>
    </div>
    <div class="d-flex gap-2">
        <button onclick="generatePDF()" class="btn btn-primary rounded-pill px-4">ðŸ“„ Export PDF</button>
        <button onclick="clearAllData()" class="btn btn-outline-danger rounded-pill px-4">ðŸ—‘ Clear All</button>
    </div>
</div>

<div class="row mb-5 justify-content-center">
    <div class="col-md-4">
        <div class="balance-box">
            <small class="text-uppercase fw-bold text-muted">Net Balance</small>
            <h2 id="netBalance" class="display-6 fw-bold text-info">0</h2>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-6">
        <div class="card-custom">
            <h4 class="text-success mb-4">+ Income</h4>
            <div class="input-group mb-4">
                <input type="text" id="incSource" class="form-control" placeholder="Source">
                <input type="number" id="incAmt" class="form-control" placeholder="Amount">
                <button onclick="addIncome()" class="btn btn-success px-4">Add</button>
            </div>
            <table class="table table-hover"><tbody id="incomeTable"></tbody></table>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card-custom">
            <h4 class="text-danger mb-4">- Expenses</h4>
            <div class="input-group mb-4">
                <input type="text" id="expDesc" class="form-control" placeholder="Description">
                <input type="number" id="expAmt" class="form-control" placeholder="Amount">
                <button onclick="addExpense()" class="btn btn-danger px-4">Add</button>
            </div>
            <table class="table table-hover"><tbody id="expenseTable"></tbody></table>
        </div>
    </div>
</div>

<div class="row mt-5">
    <div class="col-12">
        <div class="card-custom">
            <h4 class="mb-4">Visual Analytics</h4>
            <div style="height: 300px;"><canvas id="financeChart"></canvas></div>
        </div>
    </div>
</div>

<script>
    const API_EXP = "http://localhost:8080/api/expenses";
    const API_INC = "http://localhost:8080/api/income";
    let myChart;

    // Formats numbers for India system, NO dollar symbol
    const fmt = (num) => new Intl.NumberFormat('en-IN').format(num);

    async function fetchData() {
        const [resExp, resInc] = await Promise.all([fetch(API_EXP), fetch(API_INC)]);
        const expenses = await resExp.json();
        const incomes = await resInc.json();
        let tIn = 0, tOut = 0;

        const render = (data, elementId, colorClass, prefix, type) => {
            const el = document.getElementById(elementId);
            el.innerHTML = "";
            data.forEach(item => {
                const amt = parseFloat(item.amount);
                if(type === 'expense') tOut += amt; else tIn += amt;
                el.innerHTML += `<tr>
                    <td>${item.source || item.description}</td>
                    <td class="text-end fw-bold ${colorClass}">${prefix}${fmt(amt)}</td>
                    <td class="text-end" style="width: 50px;">
                        <span class="btn-delete" onclick="deleteRecord(${item.id}, '${type}')">âœ•</span>
                    </td>
                </tr>`;
            });
        };

        render(expenses, "expenseTable", "text-danger", "-", "expense");
        render(incomes, "incomeTable", "text-success", "+", "income");
        document.getElementById("netBalance").innerText = fmt(tIn - tOut);
        updateChart(tIn, tOut);
    }

    function updateChart(inc, exp) {
        const ctx = document.getElementById('financeChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Income', 'Expenses'],
                datasets: [{ data: [inc, exp], backgroundColor: ['#4ade80', '#fb7185'], borderWidth: 0 }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    async function addIncome() {
        const source = document.getElementById("incSource").value;
        const amount = document.getElementById("incAmt").value;
        if(!source || !amount) return;
        await fetch(API_INC, { method: "POST", headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ source, amount, date: new Date().toISOString().split('T')[0] }) });
        document.getElementById("incSource").value = ""; document.getElementById("incAmt").value = "";
        fetchData();
    }

    async function addExpense() {
        const description = document.getElementById("expDesc").value;
        const amount = document.getElementById("expAmt").value;
        if(!description || !amount) return;
        await fetch(API_EXP, { method: "POST", headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ description, amount, date: new Date().toISOString().split('T')[0] }) });
        document.getElementById("expDesc").value = ""; document.getElementById("expAmt").value = "";
        fetchData();
    }

    async function deleteRecord(id, type) {
        const url = type === 'income' ? API_INC : API_EXP;
        if (confirm("Delete entry?")) { await fetch(`${url}/${id}`, { method: "DELETE" }); fetchData(); }
    }

    async function clearAllData() {
        if (confirm("Wipe entire database?")) {
            await Promise.all([fetch(`${API_EXP}/clear`, {method: "DELETE"}), fetch(`${API_INC}/clear`, {method: "DELETE"})]);
            fetchData();
        }
    }

    async function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("FinanceFlow Report", 14, 20);
        const [re, ri] = await Promise.all([fetch(API_EXP), fetch(API_INC)]);
        const ex = await re.json(), in_ = await ri.json(), rows = [];
        in_.forEach(i => rows.push([i.date, i.source, "Income", `+${fmt(i.amount)}`]));
        ex.forEach(e => rows.push([e.date, e.description, "Expense", `-${fmt(e.amount)}`]));
        doc.autoTable({ startY: 30, head: [['Date', 'Description', 'Type', 'Amount']], body: rows });
        doc.save("Finance_Report.pdf");
    }

    fetchData();
</script>
</body>
</html>